#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BMP3XX.h>
#include "Light.h"
#include <Adafruit_HMC5883_U.h>

extern unsigned int __heap_start, *__brkval;

int freeRam() {
  int v;
  return (int)&v - (__brkval == 0 ? (int)&__heap_start : (int)__brkval);
}
void print2(char*x,int y) {
  Serial.print(x); Serial.println(y);
}

float smooth(float input) {
    static float filtered = input;
    const float alpha = 0.2;   // lower = smoother
    filtered = filtered + alpha * (input - filtered);
    return filtered;
}


//=================== GLOBALS =================================

#define SEALEVEL_HPA 1013.25

Adafruit_HMC5883_Unified hmc;
Adafruit_BMP3XX bmp;
//Light led1(10);
char buf[40];
U8G2_SSD1309_128X64_NONAME0_F_HW_I2C u8g2(U8G2_R0, 4);
float pressure;
float temperat;
float altitude;
float mag_x, mag_y;

unsigned long last_draw_time = millis();

void collect_data() {
  if (bmp.performReading()) {
    pressure = bmp.readPressure() / 100.0;
    altitude = bmp.readAltitude(SEALEVEL_HPA);
    temperat = bmp.readTemperature();
  }
  sensors_event_t event;
  if (hmc.getEvent(&event)) {
    mag_x = event.magnetic.x;
    mag_y = event.magnetic.y;
  }
}



//========================================
void setup() {
  Serial.begin(9600);
  for (int i=0; i<10 && !Serial; ++i) delay(20);
  Serial.println("begin setup");

  //led1.blink(100);
  u8g2.begin();

  while (!bmp.begin_I2C(0x77)) {
    Serial.println("BMP390 not found");
    delay(1000);
  }

  // Recommended altimeter settings
  bmp.setTemperatureOversampling(BMP3_OVERSAMPLING_4X);
  bmp.setPressureOversampling(BMP3_OVERSAMPLING_16X);
  bmp.setIIRFilterCoeff(BMP3_IIR_FILTER_COEFF_3);
  bmp.setOutputDataRate(BMP3_ODR_50_HZ);   // 50 Hz = fast + stable

  if (!hmc.begin()) {
    Serial.println("HMC5883L not found");
    delay(1000);
  }
  Serial.println("  end setup");
}

void screen_update() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_fub17_tr    );

  //u8g2.drawStr(0, 20, "Hello John");

  dtostrf(altitude,7,4,buf);    // meters
  u8g2.drawStr(0, 20, buf);

  u8g2.setFont(u8g2_font_luRS08_tr );

  //u8g2.drawHLine(0,30,128);
  float m = sqrt(mag_x*mag_x + mag_y*mag_y);
  dtostrf(m,7,4,buf);    // mag 
  u8g2.drawStr(64, 28, buf);
  dtostrf(mag_x,7,4,buf);    // mag X
  u8g2.drawStr(0, 40, buf);
  dtostrf(mag_y,7,4,buf);  // mag Y
  u8g2.drawStr(64, 40, buf);

  u8g2.drawHLine(0,42,128);
  dtostrf(pressure,7,4,buf);    // hPa
  u8g2.drawStr(0, 52, buf);
  dtostrf(altitude*39/12,7,4,buf);  // feet
  u8g2.drawStr(64, 52, buf);

  u8g2.drawHLine(0,53,128);
  dtostrf(temperat,7,4,buf);  // celcius
  u8g2.drawStr(0, 63, buf);
  dtostrf(temperat*9/5+32,7,4,buf);  // farenheit
  u8g2.drawStr(64, 63, buf);

  u8g2.sendBuffer();
}

//========================================
void loop() {
  //led1.update();

  if (last_draw_time + 50 < millis()) {
    screen_update();
    last_draw_time = millis();
  }

  collect_data();
}

